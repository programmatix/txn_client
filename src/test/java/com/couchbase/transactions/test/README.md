This is C&Ped from Couchbase java-client.  It should be tidied up into a real library at some point.